---
- name: Test On VCenter
  when: run_on_vcenter
  environment: "{{ environment_auth_vars }}"

  block:
    - name: Create basic VM for other tests
      vmware.vmware._vm_stub:
        name: "{{ test_vm_name }}"
        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster_name }}"
        datastore: "{{ shared_storage_01 }}"
        guest_id: amazonlinux3_64Guest
        cpu:
          cores: 2
        memory:
          size_mb: 1024
        disks:
          - location: "{{ shared_storage_01 }}"
            size: 10gb
            provisioning: thin
            sharing: no_sharing
            mode: persistent
            device_node: SCSI(0:0)
        scsi_controllers:
          - controller_type: buslogic
            bus_sharing: noSharing
      register: _basic_create_task

    - name: Store VM moid
      ansible.builtin.set_fact:
        test_vm_moid: "{{ _basic_create_task.vm.moid }}"

    # from this point on, the vm definition above is not reliable. Tests
    # should establish relevant vm options as a first task.
    # - name: Test vm update
    #   ansible.builtin.include_tasks: basic_vm_update_tests.yml

    # - name: Test cpu params
    #   ansible.builtin.include_tasks: cpu_params_tests.yml

    - name: Test memory params
      ansible.builtin.include_tasks: mem_params_tests.yml

    - name: Test network adapter params
      ansible.builtin.include_tasks: network_adapter_params_tests.yml

  always:
    - name: Power off vm
      vmware.vmware.vm_powerstate:
        datacenter: "{{ vcenter_datacenter }}"
        moid: "{{ test_vm_name }}"
        state: powered-off

    - name: Delete VM
      vmware.vmware._vm_stub:
        name: "{{ test_vm_name }}"
        datacenter: "{{ vcenter_datacenter }}"
        state: absent
