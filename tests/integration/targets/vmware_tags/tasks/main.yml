---
- name: Test On VCenter
  environment: "{{ environment_auth_vars }}"
  when: run_on_vcenter
  block:
    - name: Include category tests
      ansible.builtin.include_tasks:
        file: test_categories.yml
    - name: Include tag tests
      ansible.builtin.include_tasks:
        file: test_tags.yml
    - name: Include tag association tests
      ansible.builtin.include_tasks:
        file: test_association.yml
  always:
    - name: Destroy Test VM
      community.vmware.vmware_guest:
        cluster: "{{ vcenter_cluster_name }}"
        datacenter: "{{ vcenter_datacenter }}"
        state: absent
        force: true
        name: "{{ test_vm_name }}"
      when: _test_association_vm.vm is defined
    - name: Destroy Test Tags
      vmware.vmware.tags:
        state: absent
        tags: "{{ test_tags }}"
      ignore_errors: true
    - name: Destroy Test Tag Categories
      vmware.vmware.tag_categories:
        state: absent
        tag_categories: "{{ test_tag_categories }}"
